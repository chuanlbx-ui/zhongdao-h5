name: éƒ¨ç½²å·¥ä½œæµ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20.x'

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: æ„å»ºå’Œæµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: è¿è¡Œ ESLint
      run: npm run lint

    - name: è¿è¡Œç±»å‹æ£€æŸ¥
      run: npx tsc --noEmit

    - name: æ„å»ºåº”ç”¨
      run: npm run build
      env:
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        VITE_ENVIRONMENT: production

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: h5-build-files
        path: dist/
        retention-days: 7

  # éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
  deploy-staging:
    name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: staging

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: h5-build-files
        path: dist/

    - name: éƒ¨ç½²åˆ° Vercel (é¢„å‘å¸ƒ)
      uses: vercel/action@v1
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      env:
        VERCEL_ENV: preview

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: h5-build-files
        path: dist/

    - name: éƒ¨ç½²åˆ° Vercel (ç”Ÿäº§)
      uses: vercel/action@v1
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      env:
        VERCEL_ENV: production

    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: |
          ğŸš€ H5å‰ç«¯éƒ¨ç½²å®Œæˆ
          ç¯å¢ƒ: Production
          åˆ†æ”¯: ${{ github.ref_name }}
          æäº¤: ${{ github.sha }}
          éƒ¨ç½²çŠ¶æ€: ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶æœåŠ¡å™¨ (å¤‡é€‰æ–¹æ¡ˆ)
  deploy-static:
    name: éƒ¨ç½²åˆ°é™æ€æ–‡ä»¶æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event.inputs.environment == 'production'
    environment: production

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: h5-build-files
        path: dist/

    - name: éƒ¨ç½²åˆ°é™æ€æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.STATIC_HOST }}
        username: ${{ secrets.STATIC_USERNAME }}
        key: ${{ secrets.STATIC_SSH_KEY }}
        source: "dist/*"
        target: ${{ secrets.STATIC_PATH }}/h5/
        strip_components: 1

    - name: æ¸…ç†CDNç¼“å­˜
      run: |
        curl -X POST "${{ secrets.CDN_API_URL }}/invalidate" \
          -H "Authorization: Bearer ${{ secrets.CDN_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"paths": ["/*"]}'

  # éƒ¨ç½²åå¥åº·æ£€æŸ¥
  health-check:
    name: å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
    - name: ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
      run: sleep 60

    - name: æ£€æŸ¥é¢„å‘å¸ƒç¯å¢ƒ
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_URL }})
        if [ $response -eq 200 ]; then
          echo "âœ… é¢„å‘å¸ƒç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ é¢„å‘å¸ƒç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥: HTTP $response"
          exit 1
        fi

    - name: æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ
      if: needs.deploy-production.result == 'success'
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }})
        if [ $response -eq 200 ]; then
          echo "âœ… ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥: HTTP $response"
          exit 1
        fi

    - name: æ€§èƒ½ç›‘æ§æ£€æŸ¥
      run: |
        # æ£€æŸ¥å…³é”®æ€§èƒ½æŒ‡æ ‡
        response=$(curl -s ${{ secrets.PRODUCTION_URL }})

        # æ£€æŸ¥å…³é”®èµ„æºæ˜¯å¦åŠ è½½
        if echo "$response" | grep -q "main.js"; then
          echo "âœ… JavaScriptæ–‡ä»¶åŠ è½½æ­£å¸¸"
        else
          echo "âŒ JavaScriptæ–‡ä»¶åŠ è½½å¼‚å¸¸"
          exit 1
        fi

        if echo "$response" | grep -q "API Error"; then
          echo "âŒ å‘ç°APIé”™è¯¯"
          exit 1
        else
          echo "âœ… æœªå‘ç°APIé”™è¯¯"
        fi